FROM parity/parity:v1.11.8

ARG NPM_TOKEN
RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

RUN mkdir -p /parity

WORKDIR /parity

COPY ./parity/chain/spec.json      spec.json
COPY ./parity/chain/reserved_peers reserved_peers

ARG PARITY_ID
ARG S3_ACCESS_KEY_ID
ARG S3_SECRET_ACCESS_KEY
ARG S3_BUCKET_NAME

RUN echo "Building parity${PARITY_ID}..."

COPY ./parity/${PARITY_ID}/password       password
COPY ./parity/${PARITY_ID}/authority.toml authority.toml
COPY ./parity/${PARITY_ID}/parity         ./data/keys/parity
COPY ./parity/${PARITY_ID}/network.key    ./data/network/key

RUN mkdir ~/.aws
RUN echo "[default]\naws_access_key_id = $S3_ACCESS_KEY_ID\naws_secret_access_key = $S3_SECRET_ACCESS_KEY" > ~/.aws/credentials

RUN apt-get update -y
RUN apt-get install -y curl bash redis-tools
RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -
RUN apt-get install nodejs -y && \
  rm -rf /tmp/*

COPY ./package* /parity/
COPY ./backup /parity/
RUN npm install

ENTRYPOINT [ "bash", "./entrypoint-parity.sh" ]
