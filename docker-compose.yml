version: "3.6"

networks:
  main:
    attachable: true

services:
  api:
    hostname: launchpad-api
    image: appliedblockchain/launchpad-api:latest
    build:
      context: .
      dockerfile: ./api/Dockerfile
      args:
        - NPM_TOKEN
    environment:
      - NODE_ENV=staging
      - PROVIDER=http://parity1:8545
      - SENTRY_DSN=http://6f20a6d7d8154e1f93593c634f943f7d@sentry-web:9000/3
      - CONTRACT_ADDRESS=$CONTRACT_ADDRESS
    networks:
      - main
    ports:
      - 3000:3000
    depends_on:
      - parity1
      - parity2
      - parity3
    deploy: &deploy_defaults
      mode: global
      update_config:
        parallelism: 3
        delay: 1s
      restart_policy:
        condition: on-failure

  react:
    hostname: launchpad-react
    image: appliedblockchain/launchpad-react:latest
    build:
      context: ./react
      args:
        - NPM_TOKEN
        - BASIC_AUTH_HTPASSWD=admin:$$apr1$$6SESoef2$$haXLi9RTR.MOe76pJGH8r.
        - TEST_MODE # if set, the react app will be built to use localhost as a backend
    ports:
      - 80:80
    networks:
      - main
    deploy:
      <<: *deploy_defaults
  parity1:
    hostname: launchpad-parity1
    build:
      context: ./stack
      dockerfile: Dockerfile-parity
      args:
        - PARITY_ID=1
        - NPM_TOKEN
        - S3_ACCESS_KEY_ID
        - S3_SECRET_ACCESS_KEY
        - S3_BUCKET_NAME
    environment:
      - PARITY_ID=1
    depends_on:
      - discovery
    networks:
    - main
    ports:
    - 8180:8180
    - 8545:8545
    - 8546:8546
    - 30303:30303
    image: appliedblockchain/launchpad-parity1:latest
    volumes:
    - parity1_data:/parity/data
  parity2:
    hostname: launchpad-parity2
    build:
      context: ./stack
      dockerfile: Dockerfile-parity
      args:
        - PARITY_ID=2
        - NPM_TOKEN
    environment:
      - PARITY_ID=2
    networks:
    - main
    image: appliedblockchain/launchpad-parity2:latest
    volumes:
    - parity2_data:/parity/data
  parity3:
    hostname: launchpad-parity3
    build:
      context: ./stack
      dockerfile: Dockerfile-parity
      args:
        - PARITY_ID=3
        - NPM_TOKEN
    environment:
      - PARITY_ID=3
    networks:
    - main
    image: appliedblockchain/launchpad-parity3:latest
    volumes:
    - parity3_data:/parity/data
  discovery:
    hostname: launchpad-discovery
    image: redis
    ports:
      - 6379:6379
    networks:
    - main
    deploy:
      update_config:
        parallelism: 1
        delay: 1s
      restart_policy:
        condition: on-failure

  logspout:
    image: gliderlabs/logspout
    deploy:
      mode: global
    # NOTE: change the papertrail url/port before deploying your project
    command: syslog+tls://logs7.papertrailapp.com:32046
    volumes:
      - type: bind
        target: /var/run/docker.sock
        source: /var/run/docker.sock

volumes:
  parity1_data:
  parity2_data:
  parity3_data:
